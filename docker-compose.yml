# Stackyn Platform-as-a-Service Docker Compose Configuration
#
# This file defines all services required to run the Stackyn PaaS platform:
#   - Traefik: Reverse proxy and load balancer with automatic SSL/TLS
#   - Frontend: React/Vite web application
#   - Backend: Go API server
#   - Worker: Background deployment processor
#   - PostgreSQL: Database for apps and deployments
#
# Setup Instructions:
#   1. Ensure Docker and Docker Compose are installed
#   2. Set environment variables (or use defaults):
#      - DATABASE_URL: PostgreSQL connection string
#      - POSTGRES_USER: Database user (default: stackyn)
#      - POSTGRES_PASSWORD: Database password (default: changeme)
#      - POSTGRES_DB: Database name (default: stackyn)
#      - BASE_DOMAIN: Base domain for deployments (default: staging.stackyn.com)
#   3. Create required directories:
#      - ./volumes/db (for PostgreSQL data)
#      - ./volumes/logs (for application logs)
#      - ./traefik/acme (for SSL certificates)
#   4. Run: docker compose up -d
#
# Deployment Checklist:
#   - [ ] Update BASE_DOMAIN environment variable
#   - [ ] Update Traefik email in traefik/traefik.yml
#   - [ ] Set secure POSTGRES_PASSWORD
#   - [ ] Configure production environment variables in backend/config/prod.env
#   - [ ] Ensure volumes directory has proper permissions
#   - [ ] Verify Docker socket permissions for backend/worker
#   - [ ] Test health endpoints: http://localhost/health
#   - [ ] Verify Traefik dashboard (if enabled): http://localhost:8080
#
# Network Architecture:
#   All services run on the 'stackyn-network' bridge network.
#   Traefik acts as the entry point, routing requests to frontend/backend.
#   Deployed apps are also routed through Traefik with dynamic subdomains.
#
# Volume Mounts:
#   - ./volumes/db: PostgreSQL data persistence
#   - ./volumes/logs: Application logs
#   - ./traefik/acme: SSL certificate storage (Let's Encrypt)
#   - /var/run/docker.sock: Docker socket for container management

services:
  # Traefik - Reverse Proxy and Load Balancer
  # Handles routing, SSL/TLS termination, and load balancing
  # Migrated from direct nginx configuration to Traefik for better Docker integration
  traefik:
    image: traefik:v3.6.5
    container_name: stackyn-traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik dashboard (only for development)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      - ./traefik/acme:/etc/traefik/acme:rw
    networks:
      - stackyn-network
    labels:
      - "traefik.enable=true"
      # Traefik dashboard (disable in production or add authentication)
      # - "traefik.http.routers.traefik.rule=Host(`traefik.stackyn.local`) || Host(`traefik.staging.stackyn.com`)"
      # - "traefik.http.routers.traefik.entrypoints=websecure"
      # - "traefik.http.routers.traefik.service=api@internal"
      # - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
    environment:
      - TRAEFIK_LOG_LEVEL=INFO

  # Frontend - React (Vite) Application
  # Serves the web UI for managing applications and deployments
  # Built with Vite and served using 'serve' static file server
  # API base URL is configured at build time via VITE_API_BASE_URL
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=https://api.staging.stackyn.com
    container_name: stackyn-frontend
    restart: unless-stopped
    networks:
      - stackyn-network
    labels:
      - "traefik.enable=true"
      # HTTP router for .local (no SSL)
      - "traefik.http.routers.frontend-http.rule=Host(`stackyn.local`)"
      - "traefik.http.routers.frontend-http.entrypoints=web"
      - "traefik.http.routers.frontend-http.service=frontend"
      # HTTPS router for real domain (with SSL)
      - "traefik.http.routers.frontend-https.rule=Host(`staging.stackyn.com`)"
      - "traefik.http.routers.frontend-https.entrypoints=websecure"
      - "traefik.http.routers.frontend-https.service=frontend"
      - "traefik.http.routers.frontend-https.tls.certresolver=letsencrypt"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
    depends_on:
      - backend

  # Backend - Go API Server
  # Provides REST API for app and deployment management
  # Requires access to Docker socket for container operations
  # Connects to PostgreSQL for data persistence
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: stackyn-backend
    restart: unless-stopped
    networks:
      - stackyn-network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./backend/config/prod.env:/app/.env:ro
      - ./volumes/db:/app/data/db:rw
      - ./volumes/logs:/app/data/logs:rw
    environment:
      - DATABASE_URL=${DATABASE_URL:-postgres://stackyn:changeme@postgres:5432/stackyn?sslmode=disable}
      - DOCKER_HOST=unix:///var/run/docker.sock
      - BASE_DOMAIN=${BASE_DOMAIN:-staging.stackyn.com}
      - PORT=8080
    labels:
      - "traefik.enable=true"
      # HTTP router for .local (no SSL)
      - "traefik.http.routers.backend-http.rule=Host(`api.stackyn.local`)"
      - "traefik.http.routers.backend-http.entrypoints=web"
      - "traefik.http.routers.backend-http.service=backend"
      # HTTPS router for real domain (with SSL)
      - "traefik.http.routers.backend-https.rule=Host(`api.staging.stackyn.com`)"
      - "traefik.http.routers.backend-https.entrypoints=websecure"
      - "traefik.http.routers.backend-https.service=backend"
      - "traefik.http.routers.backend-https.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend.loadbalancer.server.port=8080"
    depends_on:
      - postgres
    command: ["/app/api"]

  # Worker - Deployment Processor
  # Background service that processes pending deployments
  # Continuously polls for pending deployments and executes:
  #   1. Git repository cloning
  #   2. Docker image building
  #   3. Container creation and startup
  #   4. Traefik routing configuration
  # Runs as root to access Docker socket (required for container management)
  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: stackyn-worker
    restart: unless-stopped
    user: "0"  # Run as root to access Docker socket
    networks:
      - stackyn-network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./backend/config/prod.env:/app/.env:ro
      - ./volumes/db:/app/data/db:rw
      - ./volumes/logs:/app/data/logs:rw
    environment:
      - DATABASE_URL=${DATABASE_URL:-postgres://stackyn:changeme@postgres:5432/stackyn?sslmode=disable}
      - DOCKER_HOST=unix:///var/run/docker.sock
      - BASE_DOMAIN=${BASE_DOMAIN:-staging.stackyn.com}
    depends_on:
      - postgres
      - backend
    command: ["/app/worker"]

  # PostgreSQL Database
  # Stores application metadata, deployment records, and status
  # Data persists in ./volumes/db directory
  # Health check ensures database is ready before other services start
  postgres:
    image: postgres:16-alpine
    container_name: stackyn-postgres
    restart: unless-stopped
    networks:
      - stackyn-network
    volumes:
      - ./volumes/db:/var/lib/postgresql/data:rw
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-stackyn}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - POSTGRES_DB=${POSTGRES_DB:-stackyn}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-stackyn}"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  stackyn-network:
    driver: bridge
    name: stackyn-network

