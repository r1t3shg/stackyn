# Docker Compose file for Stackyn Platform
# Note: 'version' is obsolete in newer Docker Compose versions

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: stackyn-postgres
    environment:
      POSTGRES_DB: stackyn
      POSTGRES_USER: stackyn_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Initialize database schema on first startup
      - ./server/init_db.sql:/docker-entrypoint-initdb.d/init_db.sql:ro
    # Port mapping removed - services access via Docker network
    # If you need external access, uncomment: - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U stackyn_user -d stackyn"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - stackyn-network
    restart: unless-stopped

  # Redis
  redis:
    image: redis:7-alpine
    container_name: stackyn-redis
    command: 
      - redis-server
      - --requirepass
      - ${REDIS_PASSWORD:-}
    # Port mapping removed - services access via Docker network
    # If you need external access, uncomment: - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD-SHELL", "if [ -n \"$$REDIS_PASSWORD\" ]; then redis-cli -a \"$$REDIS_PASSWORD\" ping; else redis-cli ping; fi"]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    networks:
      - stackyn-network
    restart: unless-stopped

  # Traefik Reverse Proxy
  traefik:
    image: traefik:v3.6.6
    container_name: stackyn-traefik
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=stackyn-network"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Let's Encrypt ACME configuration
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@stackyn.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      # Production Let's Encrypt CA server
      # Production: https://acme-v02.api.letsencrypt.org/directory
      - "--certificatesresolvers.letsencrypt.acme.caserver=https://acme-v02.api.letsencrypt.org/directory"
      # ACME configuration improvements
      - "--certificatesresolvers.letsencrypt.acme.keytype=RSA4096"
      # Logging for debugging SSL certificate issues
      - "--log.level=INFO"
      - "--accesslog=true"
    ports:
      - "80:80"
      - "443:443"
      - "8081:8080"  # Traefik dashboard (avoid conflict with API)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_data:/letsencrypt
    networks:
      - stackyn-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # API Server
  api:
    build:
      context: ./server
      dockerfile: Dockerfile.api
    container_name: stackyn-api
    environment:
      SERVER_ADDR: 0.0.0.0
      SERVER_PORT: 8080
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: stackyn_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DATABASE: stackyn
      POSTGRES_SSLMODE: disable
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: 0
      DOCKER_HOST: unix:///var/run/docker.sock
      DOCKER_API_VERSION: 1.43
      DOCKER_TLS_ENABLED: false
      TRAEFIK_API_URL: http://traefik:8080
      TRAEFIK_ENTRY_POINT: web
      TRAEFIK_NETWORK_NAME: stackyn-network
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: 3600
      LOG_LEVEL: info
      WORKER_CONCURRENCY: 10
      EMAIL_RESEND_API_KEY: ${RESEND_API_KEY:-re_6iU1KmCf_3p6MzQRbsDyerP736x1WWExj}
      EMAIL_FROM_EMAIL: ${EMAIL_FROM_EMAIL:-noreply@stackyn.com}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./server/logs:/app/logs
    # Expose port for local development access only
    # For VPS/production, Traefik handles all routing, so port mapping is not needed
    # Uncomment the following lines for local development:
    # ports:
    #   - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - stackyn-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=stackyn-network"
      # HTTP router for localhost (no TLS, no redirect) - for local development
      - "traefik.http.routers.api-localhost.rule=Host(`localhost`) || Host(`localhost:8080`)"
      - "traefik.http.routers.api-localhost.entrypoints=web"
      - "traefik.http.routers.api-localhost.service=api"
      - "traefik.http.routers.api-localhost.tls=false"
      # HTTP router for production (redirects to HTTPS) - only matches production domain
      - "traefik.http.routers.api-http.rule=Host(`${API_DOMAIN:-api.staging.stackyn.com}`)"
      - "traefik.http.routers.api-http.entrypoints=web"
      - "traefik.http.routers.api-http.middlewares=api-redirect"
      - "traefik.http.routers.api-http.tls=false"
      # HTTPS router (main router with SSL) - only for production domain (explicit match, no regex)
      - "traefik.http.routers.api.rule=Host(`${API_DOMAIN:-api.staging.stackyn.com}`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls=true"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      - "traefik.http.services.api.loadbalancer.server.port=8080"
      # Redirect middleware
      - "traefik.http.middlewares.api-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.api-redirect.redirectscheme.permanent=true"

  # Build Worker
  build-worker:
    build:
      context: ./server
      dockerfile: Dockerfile.build-worker
    container_name: stackyn-build-worker
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: stackyn_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DATABASE: stackyn
      POSTGRES_SSLMODE: disable
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: 0
      DOCKER_HOST: unix:///var/run/docker.sock
      DOCKER_API_VERSION: 1.43
      DOCKER_TLS_ENABLED: false
      JWT_SECRET: ${JWT_SECRET}
      LOG_LEVEL: info
      WORKER_CONCURRENCY: 10
      APP_BASE_DOMAIN: ${APP_BASE_DOMAIN:-staging.stackyn.com}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./server/logs:/app/logs
      - build_workspace:/app/workspace
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - stackyn-network
    restart: unless-stopped

  # Deploy Worker
  deploy-worker:
    build:
      context: ./server
      dockerfile: Dockerfile.deploy-worker
    container_name: stackyn-deploy-worker
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: stackyn_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DATABASE: stackyn
      POSTGRES_SSLMODE: disable
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: 0
      DOCKER_HOST: unix:///var/run/docker.sock
      DOCKER_API_VERSION: 1.43
      DOCKER_TLS_ENABLED: false
      TRAEFIK_API_URL: http://traefik:8080
      TRAEFIK_ENTRY_POINT: web
      TRAEFIK_NETWORK_NAME: stackyn-network
      JWT_SECRET: ${JWT_SECRET}
      LOG_LEVEL: info
      WORKER_CONCURRENCY: 10
      APP_BASE_DOMAIN: ${APP_BASE_DOMAIN:-staging.stackyn.com}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./server/logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      traefik:
        condition: service_started
    networks:
      - stackyn-network
    restart: unless-stopped

  # Cleanup Worker
  cleanup-worker:
    build:
      context: ./server
      dockerfile: Dockerfile.cleanup-worker
    container_name: stackyn-cleanup-worker
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: stackyn_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DATABASE: stackyn
      POSTGRES_SSLMODE: disable
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: 0
      DOCKER_HOST: unix:///var/run/docker.sock
      DOCKER_API_VERSION: 1.43
      DOCKER_TLS_ENABLED: false
      JWT_SECRET: ${JWT_SECRET}
      LOG_LEVEL: info
      APP_BASE_DOMAIN: ${APP_BASE_DOMAIN:-staging.stackyn.com}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./server/logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - stackyn-network
    restart: unless-stopped

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: ${FRONTEND_API_URL:-https://api.staging.stackyn.com}
    container_name: stackyn-frontend
    ports:
      - "3000:3000"
    networks:
      - stackyn-network
    depends_on:
      - api
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=stackyn-network"
      # Service configuration - define first so routers can reference it
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
      - "traefik.http.services.frontend.loadbalancer.server.scheme=http"
      # HTTP router for localhost (no TLS, no redirect) - for local development
      - "traefik.http.routers.frontend-localhost.rule=Host(`localhost`) || Host(`localhost:3000`)"
      - "traefik.http.routers.frontend-localhost.entrypoints=web"
      - "traefik.http.routers.frontend-localhost.service=frontend"
      - "traefik.http.routers.frontend-localhost.tls=false"
      # HTTP router for production main domain (redirects to HTTPS) - explicit domain match
      - "traefik.http.routers.frontend-http.rule=Host(`${FRONTEND_DOMAIN:-staging.stackyn.com}`)"
      - "traefik.http.routers.frontend-http.entrypoints=web"
      - "traefik.http.routers.frontend-http.middlewares=frontend-redirect"
      - "traefik.http.routers.frontend-http.tls=false"
      # HTTPS router for main domain (with SSL) - explicit domain match
      - "traefik.http.routers.frontend.rule=Host(`${FRONTEND_DOMAIN:-staging.stackyn.com}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.service=frontend"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      # HTTP router for console subdomain (redirects to HTTPS) - explicit domain match
      - "traefik.http.routers.console-http.rule=Host(`${CONSOLE_DOMAIN:-console.staging.stackyn.com}`)"
      - "traefik.http.routers.console-http.entrypoints=web"
      - "traefik.http.routers.console-http.middlewares=console-redirect"
      - "traefik.http.routers.console-http.tls=false"
      # HTTPS router for console subdomain (with SSL) - explicit domain match
      - "traefik.http.routers.console.rule=Host(`${CONSOLE_DOMAIN:-console.staging.stackyn.com}`)"
      - "traefik.http.routers.console.entrypoints=websecure"
      - "traefik.http.routers.console.service=frontend"
      - "traefik.http.routers.console.tls=true"
      - "traefik.http.routers.console.tls.certresolver=letsencrypt"
      # Redirect middlewares
      - "traefik.http.middlewares.frontend-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.frontend-redirect.redirectscheme.permanent=true"
      - "traefik.http.middlewares.console-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.console-redirect.redirectscheme.permanent=true"

networks:
  stackyn-network:
    name: stackyn-network
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  traefik_data:
  build_workspace:

